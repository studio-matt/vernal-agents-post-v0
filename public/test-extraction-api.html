<!DOCTYPE html>
<html>
<head>
    <title>Test Extraction API</title>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress {
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 3px;
            margin: 10px 0;
        }
        .progress-bar {
            background-color: #4CAF50;
            height: 20px;
            border-radius: 7px;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>Test Extraction API</h1>
    <p><strong>Note:</strong> This API call can take 2-5 minutes as it performs web scraping, content analysis, and topic modeling.</p>
    
    <div style="margin: 20px 0;">
        <h3>Test with Your Real Campaigns:</h3>
        <button onclick="testCampaign('backyard-telescope')" id="btn1" class="campaign-btn">Test "Backyard Telescope" Campaign</button>
        <button onclick="testCampaign('blockchain-provenance')" id="btn2" class="campaign-btn">Test "Blockchain Provenance" Campaign</button>
    </div>
    
    <div style="margin: 20px 0;">
        <h3>Test with Generic Data:</h3>
        <button onclick="testAPI()" id="testBtn">Test Generic API Call</button>
    </div>
    
    <div id="result"></div>

    <script>
        let startTime;
        let progressInterval;
        
        // Your real campaign data
        const campaigns = {
            'backyard-telescope': {
                campaign_name: "Backyard Telescope",
                campaign_id: "campaign-1759335272705",
                urls: [],
                query: "Looking for things a backyard telescope enthusiast might enjoy reading about. Focussing in on new things but calling out workflow augmentations and new scopes.",
                description: "Campaign for all things backyard telescope related",
                keywords: ["backyard telescope", "astrophotography", "amateur telescope"],
                type: "keyword",
                depth: 3,
                max_pages: 15,
                batch_size: 20,
                include_links: false,
                stem: true,
                lemmatize: true,
                remove_stopwords_toggle: true,
                extract_persons: true,
                extract_organizations: true,
                extract_locations: true,
                extract_dates: true,
                topic_tool: "llm",
                num_topics: 5,
                iterations: 100,
                pass_threshold: 0.5,
            },
            'blockchain-provenance': {
                campaign_name: "Blockchain Provenance",
                campaign_id: "campaign-1759335625621",
                urls: [],
                query: "Looking for companies and solutions out there attempting to solve all varieties of digital provenance using a blockchain.",
                description: "Anything relating to digital provenance on the blockchain",
                keywords: ["grouped asset nft", "blockchain provenance"],
                type: "keyword",
                depth: 2,
                max_pages: 15,
                batch_size: 30,
                include_links: false,
                stem: true,
                lemmatize: true,
                remove_stopwords_toggle: true,
                extract_persons: true,
                extract_organizations: true,
                extract_locations: true,
                extract_dates: true,
                topic_tool: "llm",
                num_topics: 5,
                iterations: 100,
                pass_threshold: 0.5,
            }
        };
        
        function updateProgress() {
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            const progressDiv = document.getElementById('progress');
            if (progressDiv) {
                progressDiv.innerHTML = `
                    <div class="progress">
                        <div class="progress-bar" style="width: ${Math.min(90, (seconds / 60) * 20)}%"></div>
                    </div>
                    <p>‚è±Ô∏è Elapsed time: ${minutes}m ${remainingSeconds}s</p>
                    <p>üîÑ This can take 2-5 minutes. Please be patient...</p>
                `;
            }
        }
        
        async function testCampaign(campaignKey) {
            const campaign = campaigns[campaignKey];
            if (!campaign) {
                alert('Campaign not found!');
                return;
            }
            
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById(`btn${campaignKey === 'backyard-telescope' ? '1' : '2'}`);
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            startTime = Date.now();
            
            resultDiv.innerHTML = `
                <div id="progress">
                    <div class="loading"></div>
                    <p>üöÄ Testing "${campaign.campaign_name}" campaign...</p>
                    <p><strong>Keywords:</strong> ${campaign.keywords.join(', ')}</p>
                    <p><strong>Query:</strong> ${campaign.query}</p>
                </div>
            `;
            
            // Start progress updates
            progressInterval = setInterval(updateProgress, 1000);
            
            try {
                console.log('Testing campaign:', campaign);

                // Step 1: Start the analysis (new asynchronous endpoint)
                const startResponse = await fetch('https://themachine.vernalcontentum.com/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(campaign)
                });

                console.log('Start response status:', startResponse.status);
                const startData = await startResponse.json();
                console.log('Start response data:', startData);

                if (startData.status !== 'started') {
                    throw new Error(`Failed to start analysis: ${startData.error || 'Unknown error'}`);
                }

                const taskId = startData.task_id;
                console.log('Task ID:', taskId);

                // Step 2: Poll for progress updates
                let isComplete = false;
                let finalData = null;
                
                while (!isComplete) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds between polls
                    
                    try {
                        const statusResponse = await fetch(`https://themachine.vernalcontentum.com/analyze/status/${taskId}`, {
                            headers: {
                            }
                        });
                        
                        const statusData = await statusResponse.json();
                        console.log('Status update:', statusData);
                        
                        // Update progress display
                        const progressDiv = document.getElementById('progress');
                        if (progressDiv) {
                            progressDiv.innerHTML = `
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${statusData.progress}%"></div>
                                </div>
                                <p>‚è±Ô∏è Elapsed time: ${Math.floor((Date.now() - startTime) / 60000)}m ${Math.floor(((Date.now() - startTime) % 60000) / 1000)}s</p>
                                <p>üîÑ ${statusData.message} (${statusData.progress}%)</p>
                                <p>üìä Current step: ${statusData.current_step}</p>
                            `;
                        }
                        
                        if (statusData.status === 'completed') {
                            isComplete = true;
                            finalData = statusData.result;
                        } else if (statusData.status === 'failed') {
                            throw new Error(`Analysis failed: ${statusData.error}`);
                        }
                    } catch (statusError) {
                        console.error('Status check error:', statusError);
                        throw new Error(`Failed to check status: ${statusError.message}`);
                    }
                }

                // Clear progress updates
                clearInterval(progressInterval);
                
                const elapsed = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                resultDiv.innerHTML = `
                    <h3>‚úÖ Campaign Test Results for "${campaign.campaign_name}":</h3>
                    <p><strong>Status:</strong> ${startResponse.status}</p>
                    <p><strong>Total Time:</strong> ${minutes}m ${seconds}s</p>
                    <p><strong>Posts Found:</strong> ${finalData.posts ? finalData.posts.length : 0}</p>
                    <p><strong>Topics Found:</strong> ${finalData.topics ? finalData.topics.length : 0}</p>
                    <p><strong>Summary:</strong> ${finalData.summary ? `URLs Scraped: ${finalData.summary.total_urls_scraped || 'N/A'}, Content Size: ${finalData.summary.total_content_size || 'N/A'}` : 'No summary data'}</p>
                    <p><strong>Persons:</strong> ${finalData.persons ? finalData.persons.length : 0}</p>
                    <p><strong>Organizations:</strong> ${finalData.organizations ? finalData.organizations.length : 0}</p>
                    <p><strong>Locations:</strong> ${finalData.locations ? finalData.locations.length : 0}</p>
                    <p><strong>Dates:</strong> ${finalData.dates ? finalData.dates.length : 0}</p>
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h4>üîç URL Analysis:</h4>
                        <p><strong>Individual URLs in Posts:</strong> ${finalData.posts ? finalData.posts.filter(post => post.url).length : 0} out of ${finalData.posts ? finalData.posts.length : 0} posts</p>
                        <p><strong>Expected vs Actual:</strong> If summary shows ${finalData.summary ? finalData.summary.total_urls_scraped : 'N/A'} URLs scraped, but only ${finalData.posts ? finalData.posts.filter(post => post.url).length : 0} individual posts have URLs, then the API needs to be updated to return individual post objects.</p>
                    </div>
                    <details>
                        <summary><strong>üìä Detailed Response Data</strong></summary>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 400px;">${JSON.stringify(finalData, null, 2)}</pre>
                    </details>
                `;
                
                testBtn.disabled = false;
                testBtn.textContent = `Test "${campaign.campaign_name}" Campaign`;
            } catch (error) {
                console.error('Error:', error);
                
                // Clear progress updates
                clearInterval(progressInterval);
                
                const elapsed = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                resultDiv.innerHTML = `
                    <h3>‚ùå Campaign Test Error for "${campaign.campaign_name}":</h3>
                    <p><strong>Time before error:</strong> ${minutes}m ${seconds}s</p>
                    <p style="color: red;"><strong>Error:</strong> ${error.message}</p>
                `;
                
                testBtn.disabled = false;
                testBtn.textContent = `Test "${campaign.campaign_name}" Campaign`;
            }
        }
        
        async function testAPI() {
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            startTime = Date.now();
            
            resultDiv.innerHTML = `
                <div id="progress">
                    <div class="loading"></div>
                    <p>üöÄ Starting API call...</p>
                </div>
            `;
            
            // Start progress updates
            progressInterval = setInterval(updateProgress, 1000);
            
            try {
                const payload = {
                    campaign_name: "Test Campaign",
                    campaign_id: "test-campaign-123",
                    urls: ["https://example.com"],
                    query: "Test query",
                    description: "Test description",
                    keywords: ["test", "example"],
                    type: "keyword",
                    depth: 2,
                    max_pages: 5,
                    batch_size: 5,
                    include_links: false,
                    stem: false,
                    lemmatize: false,
                    remove_stopwords_toggle: false,
                    extract_persons: false,
                    extract_organizations: false,
                    extract_locations: false,
                    extract_dates: false,
                    topic_tool: "llm",
                    num_topics: 3,
                    iterations: 10,
                    pass_threshold: 0.5,
                };

                console.log('Sending payload:', payload);

                // Step 1: Start the analysis (new asynchronous endpoint)
                const startResponse = await fetch('https://themachine.vernalcontentum.com/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Start response status:', startResponse.status);
                const startData = await startResponse.json();
                console.log('Start response data:', startData);

                if (startData.status !== 'started') {
                    throw new Error(`Failed to start analysis: ${startData.error || 'Unknown error'}`);
                }

                const taskId = startData.task_id;
                console.log('Task ID:', taskId);

                // Step 2: Poll for progress updates
                let isComplete = false;
                let finalData = null;
                
                while (!isComplete) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds between polls
                    
                    try {
                        const statusResponse = await fetch(`https://themachine.vernalcontentum.com/analyze/status/${taskId}`, {
                            headers: {
                            }
                        });
                        
                        const statusData = await statusResponse.json();
                        console.log('Status update:', statusData);
                        
                        // Update progress display
                        const progressDiv = document.getElementById('progress');
                        if (progressDiv) {
                            progressDiv.innerHTML = `
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${statusData.progress}%"></div>
                                </div>
                                <p>‚è±Ô∏è Elapsed time: ${Math.floor((Date.now() - startTime) / 60000)}m ${Math.floor(((Date.now() - startTime) % 60000) / 1000)}s</p>
                                <p>üîÑ ${statusData.message} (${statusData.progress}%)</p>
                                <p>üìä Current step: ${statusData.current_step}</p>
                            `;
                        }
                        
                        if (statusData.status === 'completed') {
                            isComplete = true;
                            finalData = statusData.result;
                        } else if (statusData.status === 'failed') {
                            throw new Error(`Analysis failed: ${statusData.error}`);
                        }
                    } catch (statusError) {
                        console.error('Status check error:', statusError);
                        throw new Error(`Failed to check status: ${statusError.message}`);
                    }
                }

                // Clear progress updates
                clearInterval(progressInterval);
                
                const elapsed = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                resultDiv.innerHTML = `
                    <h3>‚úÖ API Test Results:</h3>
                    <p><strong>Status:</strong> ${startResponse.status}</p>
                    <p><strong>Total Time:</strong> ${minutes}m ${seconds}s</p>
                    <p><strong>Response:</strong></p>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(finalData, null, 2)}</pre>
                `;
                
                testBtn.disabled = false;
                testBtn.textContent = 'Test API Call';
            } catch (error) {
                console.error('Error:', error);
                
                // Clear progress updates
                clearInterval(progressInterval);
                
                const elapsed = Date.now() - startTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                resultDiv.innerHTML = `
                    <h3>‚ùå API Test Error:</h3>
                    <p><strong>Time before error:</strong> ${minutes}m ${seconds}s</p>
                    <p style="color: red;"><strong>Error:</strong> ${error.message}</p>
                    <p><strong>This could be due to:</strong></p>
                    <ul>
                        <li>API server is down or overloaded</li>
                        <li>Network timeout (try again)</li>
                        <li>Invalid request format</li>
                        <li>Server error</li>
                    </ul>
                `;
                
                testBtn.disabled = false;
                testBtn.textContent = 'Test API Call';
            }
        }
    </script>
</body>
</html>
