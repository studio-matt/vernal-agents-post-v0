name: Deploy Agents Backend

on:
  push:
    branches: [ "main", "mcp-conversion" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Agents
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: false

    # If this step fails: check log for last line (HOST=... = script ran; HEALTH_CHECK_FAILED = journalctl dump)
    - name: Deploy on Agents Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: ${{ secrets.EC2_SSH_PASSPHRASE }}
        command_timeout: "90m"
        script: |
          set -e
          REPO_DIR="/home/ubuntu/vernal-agents-post-v0"
          echo "ðŸ”’ BACKEND DEPLOY â€” HOST=$(hostname) USER=$(whoami)"
          echo "   REPO_DIR .git=$([ -d "$REPO_DIR/.git" ] && echo yes || echo no) venv=$([ -d "$REPO_DIR/venv" ] && echo yes || echo no)"

          if [ -f "$REPO_DIR/.env" ]; then
            cp "$REPO_DIR/.env" /home/ubuntu/.env.backup
            chmod 600 /home/ubuntu/.env.backup
            echo "âœ… .env backed up"
          fi
          sudo systemctl stop vernal-agents || true
          sudo pkill -9 -f "uvicorn main:app" || true
          sudo lsof -t -i:8000 2>/dev/null | xargs -r sudo kill -9 || true
          sleep 2

          if [ ! -d "$REPO_DIR/.git" ]; then
            echo "ðŸ“¦ First deploy: cloning..."
            sudo rm -rf "$REPO_DIR"
            git clone https://github.com/studio-matt/vernal-agents-post-v0.git "$REPO_DIR"
            cd "$REPO_DIR"
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip --no-cache-dir -q
            pip install -r requirements.txt --no-cache-dir --progress-bar off -q
          else
            echo "ðŸ“¦ Updating existing repo..."
            cd "$REPO_DIR"
            git fetch origin
            git checkout main
            git reset --hard origin/main
            if [ ! -d "venv" ]; then
              echo "ðŸ Creating venv..."
              python3 -m venv venv
              source venv/bin/activate
              pip install --upgrade pip --no-cache-dir -q
              pip install -r requirements.txt --no-cache-dir --progress-bar off -q
            else
              source venv/bin/activate
              pip install -r requirements.txt --no-cache-dir --progress-bar off -q
            fi
          fi

          if [ -f /home/ubuntu/.env.backup ]; then
            cp /home/ubuntu/.env.backup .env
            chmod 600 .env
            echo "âœ… .env restored"
          else
            [ -f /etc/environment ] && cp /etc/environment .env && chmod 600 .env
            echo "âš ï¸ .env from /etc/environment (check DB/JWT vars)"
          fi
          grep -q "DB_HOST\|DB_USER\|DB_PASSWORD" .env || { echo "âŒ .env missing DB credentials"; cat .env | sed 's/=.*/=***/' | head -5; exit 1; }

          sudo tee /etc/systemd/system/vernal-agents.service > /dev/null << 'SVC'
          [Unit]
          Description=Vernal Agents Backend
          After=network.target
          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/vernal-agents-post-v0
          ExecStart=/home/ubuntu/vernal-agents-post-v0/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=10
          Environment=PYTHONPATH=/home/ubuntu/vernal-agents-post-v0
          EnvironmentFile=/home/ubuntu/vernal-agents-post-v0/.env
          [Install]
          WantedBy=multi-user.target
          SVC
          sudo systemctl daemon-reload
          sudo systemctl start vernal-agents

          echo "â³ Waiting for service..."
          sleep 10
          for i in 1 2 3 4 5; do
            if curl -sf http://localhost:8000/health >/dev/null; then
              echo "âœ… Health OK"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ HEALTH_CHECK_FAILED â€” last 60 lines of vernal-agents:"
              sudo journalctl -u vernal-agents -n 60 --no-pager
              echo "--- END LOG ---"
              exit 1
            fi
            sleep 3
          done
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "DEPLOY_COMPLETE_$(date +%s)_$COMMIT_HASH" > /home/ubuntu/vernal_agents_deploy_complete.txt
          echo "ðŸŽ‰ DEPLOY SUCCESS: $COMMIT_HASH"
