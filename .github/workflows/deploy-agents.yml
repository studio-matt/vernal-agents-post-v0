name: Deploy Agents Backend

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploy Agents
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create deployment package
      run: |
        mkdir -p deployment
        cp -r * deployment/
        tar -czf agents-deployment.tar.gz -C deployment .

    - name: Copy to Agents Server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: 34.204.6.126
        username: ubuntu
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: "hah%asf"
        source: "agents-deployment.tar.gz"
        target: "/home/ubuntu/"

    - name: Deploy on Agents Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 34.204.6.126
        username: ubuntu
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: "hah%asf"
        script: |
          echo "Deploying agents backend..."
          cd /home/ubuntu
          
          # Stop existing service
          sudo systemctl stop vernal-agents || true
          
          # Backup current deployment
          if [ -d "vernal-agents" ]; then
            mv vernal-agents vernal-agents-backup-$(date +%s)
          fi
          
          # Extract new deployment
          tar -xzf agents-deployment.tar.gz -C .
          mv * vernal-agents/ 2>/dev/null || true
          
          # Install Python dependencies
          cd vernal-agents
          pip3 install -r requirements.txt
          
          # Create systemd service
          sudo tee /etc/systemd/system/vernal-agents.service > /dev/null <<EOF
          [Unit]
          Description=Vernal Agents Backend
          After=network.target
          
          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/vernal-agents
          ExecStart=/usr/bin/python3 main.py
          Restart=always
          RestartSec=10
          Environment=PYTHONPATH=/home/ubuntu/vernal-agents
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Reload systemd and start service
          sudo systemctl daemon-reload
          sudo systemctl enable vernal-agents
          sudo systemctl start vernal-agents
          
          # Clean up
          rm -f agents-deployment.tar.gz
          
          echo "Agents backend deployment completed!"
          sudo systemctl status vernal-agents
