name: Deploy Agents Backend

on:
  push:
    branches: [ "main", "mcp-conversion" ]

jobs:
  deploy:
    name: Deploy Agents
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy on Agents Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        passphrase: ${{ secrets.EC2_SSH_PASSPHRASE }}
        script: |
          set -e
          echo "ğŸ”’ BULLETPROOF BACKEND DEPLOYMENT STARTING..."

          # 0. Ensure jq is installed for JSON validation
          sudo apt-get update && sudo apt-get install -y jq

          # 1. Nuke old code completely
          echo "ğŸ§¹ Nuking old code..."
          sudo systemctl stop vernal-agents || true
          rm -rf /home/ubuntu/vernal-agents-post-v0

          # Clean up old backup directories
          echo "ğŸ§¹ Cleaning up old backup directories..."
          find /home/ubuntu -maxdepth 1 -name "vernal-agents*backup*" -type d -exec rm -rf {} + 2>/dev/null || true
          find /home/ubuntu -maxdepth 1 -name "vernal-agents*corrupted*" -type d -exec rm -rf {} + 2>/dev/null || true
          echo "âœ… Backup directories cleaned up"

          # 2. Clone fresh from GitHub
          echo "ğŸ“¦ Cloning fresh from GitHub..."
          git clone https://github.com/studio-matt/vernal-agents-post-v0.git /home/ubuntu/vernal-agents-post-v0
          cd /home/ubuntu/vernal-agents-post-v0

          # 3. Setup venv from scratch
          echo "ğŸ Setting up virtual environment..."
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

          # 4. Copy and validate environment variables
          echo "ğŸ” Setting up environment..."
          sudo cp /etc/environment .env
          sudo chown ubuntu:ubuntu .env
          chmod 600 .env

          # Validate critical environment variables
          echo "ğŸ” Validating environment variables..."
          REQUIRED_VARS=("DB_HOST" "DB_USER" "DB_PASSWORD" "DB_NAME" "OPENAI_API_KEY")
          MISSING_VARS=()

          for var in "${REQUIRED_VARS[@]}"; do
              if ! grep -q "^${var}=" .env; then
                  MISSING_VARS+=("$var")
              fi
          done

          if [ ${#MISSING_VARS[@]} -ne 0 ]; then
              echo "âŒ Missing required environment variables:"
              printf '%s\n' "${MISSING_VARS[@]}"
              echo "Please update /etc/environment or provide a complete .env file"
              exit 1
          fi

          echo "âœ… All required environment variables present"

          # 5. Overwrite systemd unit (always)
          echo "âš™ï¸ Configuring systemd service..."
          sudo tee /etc/systemd/system/vernal-agents.service > /dev/null << 'SERVICE_EOF'
          [Unit]
          Description=Vernal Agents Backend
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/vernal-agents-post-v0
          ExecStart=/home/ubuntu/vernal-agents-post-v0/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=10
          Environment=PYTHONPATH=/home/ubuntu/vernal-agents-post-v0

          [Install]
          WantedBy=multi-user.target
          SERVICE_EOF

          # 6. Reload and start service
          echo "ğŸ”„ Starting service..."
          sudo systemctl daemon-reload
          sudo systemctl start vernal-agents

          # 7. Wait for startup
          echo "â³ Waiting for service startup..."
          sleep 5

          # 8. Automated post-deploy validation (MANDATORY)
          echo "âœ… Running post-deploy validation..."

          # Health check
          echo "ğŸ” Testing health endpoint..."
          curl -f http://localhost:8000/health || { echo "âŒ Health check failed!"; exit 1; }
          echo "âœ… Health check passed"

          # Version check
          echo "ğŸ” Testing version endpoint..."
          VERSION_RESPONSE=$(curl -s http://localhost:8000/version)
          echo "$VERSION_RESPONSE" | jq . || { echo "âŒ Version endpoint returned invalid JSON!"; exit 1; }
          echo "âœ… Version check passed"

          # Database test
          echo "ğŸ” Testing database connectivity..."
          curl -f http://localhost:8000/config/test || { echo "âŒ Database test failed!"; exit 1; }
          echo "âœ… Database test passed"

          # Systemd status
          echo "ğŸ” Checking systemd status..."
          sudo systemctl status vernal-agents --no-pager || { echo "âŒ Service not running!"; exit 1; }
          echo "âœ… Service is running"

          # Port check
          echo "ğŸ” Checking port 8000..."
          sudo lsof -i :8000 || { echo "âŒ Nothing listening on port 8000!"; exit 1; }
          echo "âœ… Port 8000 is listening"

          # External access test
          echo "ğŸ” Testing external access..."
          curl -f https://themachine.vernalcontentum.com/health || { echo "âŒ External health check failed!"; exit 1; }
          curl -f https://themachine.vernalcontentum.com/version || { echo "âŒ External version check failed!"; exit 1; }
          echo "âœ… External access working"

          # 9. Log successful deployment
          COMMIT_HASH=$(git rev-parse HEAD)
          PYTHON_VERSION=$(python --version)
          echo "$(date) - BULLETPROOF Backend deployed successfully via GitHub Actions, commit: $COMMIT_HASH, Python: $PYTHON_VERSION" >> ~/vernal_agents_deploy.log

          echo "ğŸ‰ BULLETPROOF BACKEND DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“ Deployment logged to ~/vernal_agents_deploy.log"
