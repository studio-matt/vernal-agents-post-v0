name: Deploy Agents Backend to EC2

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  AGENTS_EC2_USER: ubuntu
  AGENTS_EC2_HOST: "34.204.6.126"

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Agents Backend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd agents-backend
        pip install -r requirements.txt

    - name: Create deployment package
      run: |
        cd agents-backend
        mkdir -p ../deployment
        cp -r . ../deployment/
        cd ..
        tar -czf agents-deployment.tar.gz -C deployment .

    - name: Copy to EC2
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ env.AGENTS_EC2_HOST }}
        username: ${{ env.AGENTS_EC2_USER }}
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: "hah%asf"
        source: "agents-deployment.tar.gz"
        target: "/home/ubuntu/"

    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.AGENTS_EC2_HOST }}
        username: ${{ env.AGENTS_EC2_USER }}
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: "hah%asf"
        script: |
          echo "Deploying agents backend..."
          cd /home/ubuntu
          
          # Stop existing service
          sudo systemctl stop vernal-agents || true
          
          # Backup current deployment
          if [ -d "vernal-agents" ]; then
            mv vernal-agents vernal-agents-backup-$(date +%s)
          fi
          
          # Extract new deployment
          tar -xzf agents-deployment.tar.gz -C .
          mv * vernal-agents/ 2>/dev/null || true
          
          # Install Python dependencies
          cd vernal-agents
          pip3 install -r requirements.txt
          
          # Create systemd service if it doesn't exist
          sudo tee /etc/systemd/system/vernal-agents.service > /dev/null <<EOF
          [Unit]
          Description=Vernal Agents Backend
          After=network.target
          
          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/vernal-agents
          ExecStart=/usr/bin/python3 main.py
          Restart=always
          RestartSec=10
          Environment=PYTHONPATH=/home/ubuntu/vernal-agents
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Reload systemd and start service
          sudo systemctl daemon-reload
          sudo systemctl enable vernal-agents
          sudo systemctl start vernal-agents
          
          # Clean up
          rm -f agents-deployment.tar.gz
          
          echo "Agents backend deployment completed!"
          sudo systemctl status vernal-agents