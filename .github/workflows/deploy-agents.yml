name: Deploy Agents Backend

on:
  push:
    branches: [ "main", "mcp-conversion" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Agents
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: false  # No submodules in this repo
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Deploy on Agents Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.AGENTS_EC2_SSH_KEY }}
        passphrase: ${{ secrets.EC2_SSH_PASSPHRASE }}
        command_timeout: "90m"
        script: |
          set -e
          echo "ğŸ”’ BULLETPROOF BACKEND DEPLOYMENT STARTING..."

          # 0. Ensure jq is installed (skip apt if present to avoid dpkg issues)
          command -v jq >/dev/null 2>&1 || { sudo apt-get update && sudo apt-get install -y jq; }

          # 1. BULLETPROOF NUKING - Remove entire directory in one command
          echo "ğŸ§¹ Nuking old code..."
          
          # CRITICAL: Backup .env file before deletion (EMERGENCY_NET.md v7)
          echo "ğŸ” Backing up .env file before cleanup..."
          if [ -f /home/ubuntu/vernal-agents-post-v0/.env ]; then
            sudo cp /home/ubuntu/vernal-agents-post-v0/.env /home/ubuntu/.env.backup
            sudo chown ubuntu:ubuntu /home/ubuntu/.env.backup
            chmod 600 /home/ubuntu/.env.backup
            echo "âœ… .env file backed up to /home/ubuntu/.env.backup"
          else
            echo "âš ï¸ No existing .env file found to backup"
          fi
          
          # Stop service and wait for it to fully stop
          sudo systemctl stop vernal-agents || true
          echo "â³ Waiting for service to stop..."
          sleep 5
          
          # Kill any stuck Python processes more aggressively
          sudo pkill -9 -f python || true
          sudo pkill -9 -f uvicorn || true
          sudo pkill -9 -f main.py || true
          echo "â³ Waiting for processes to terminate..."
          sleep 3
          
          # BULLETPROOF NUKING - Remove entire directory in one command
          echo "ğŸ§¹ Removing entire directory..."
          sudo rm -rf /home/ubuntu/vernal-agents-post-v0
          
          # Retry if directory still exists
          for i in {1..3}; do
            if [ -d /home/ubuntu/vernal-agents-post-v0 ]; then
              echo "âŒ Directory still exists, trying again (attempt $i)..."
              sudo rm -rf /home/ubuntu/vernal-agents-post-v0
              sleep 2
            fi
          done
          
          # Verify directory is gone
          if [ -d /home/ubuntu/vernal-agents-post-v0 ]; then
            echo "âŒ Directory could not be fully deleted. Showing contents:"
            sudo find /home/ubuntu/vernal-agents-post-v0
            exit 1
          fi

          # Clean up old backup directories
          echo "ğŸ§¹ Cleaning up old backup directories..."
          find /home/ubuntu -maxdepth 1 -name "vernal-agents*backup*" -type d -exec sudo rm -rf {} + 2>/dev/null || true
          find /home/ubuntu -maxdepth 1 -name "vernal-agents*corrupted*" -type d -exec sudo rm -rf {} + 2>/dev/null || true
          echo "âœ… Backup directories cleaned up"

          # 2. Clone fresh from GitHub
          echo "ğŸ“¦ Cloning fresh from GitHub..."
          git clone https://github.com/studio-matt/vernal-agents-post-v0.git /home/ubuntu/vernal-agents-post-v0
          cd /home/ubuntu/vernal-agents-post-v0

          # 3. Setup venv from scratch with memory optimization
          echo "ğŸ Setting up virtual environment..."
          python3 -m venv venv
          source venv/bin/activate
          
          # Memory monitoring and optimization
          echo "ğŸ“Š Memory status before pip install:"
          free -h
          
          # Aggressive memory cleanup
          echo "ğŸ§¹ Cleaning up memory..."
          sudo apt-get clean
          sudo rm -rf /var/cache/apt/archives/*
          sudo rm -rf /tmp/*
          echo "ğŸ“Š Memory after cleanup:"
          free -h
          
          # Memory optimization: upgrade pip and install with no cache
          echo "â¬†ï¸ Upgrading pip..."
          pip install --upgrade pip --no-cache-dir
          
          # Install packages in chunks to reduce memory pressure
          echo "ğŸ“¦ Installing core dependencies..."
          pip install fastapi uvicorn sqlalchemy pymysql python-multipart --no-cache-dir --progress-bar off
          echo "ğŸ“Š Memory after core:"
          free -h
          
          echo "ğŸ“¦ Installing AI dependencies..."
          pip install openai anthropic tiktoken --no-cache-dir --progress-bar off
          echo "ğŸ“Š Memory after AI:"
          free -h
          
          echo "ğŸ“¦ Installing remaining dependencies..."
          pip install -r requirements.txt --no-cache-dir --progress-bar off
          echo "ğŸ“Š Memory after all:"
          free -h
          
          # Note: No pip cache purge needed - using --no-cache-dir already
          
          echo "ğŸ“Š Memory status after pip install:"
          free -h
          
          # Check if we're running low on memory
          AVAILABLE_MEM=$(free -m | awk 'NR==2{printf "%.0f", $7}')
          if [ "$AVAILABLE_MEM" -lt 100 ]; then
            echo "âš ï¸ WARNING: Low memory detected ($AVAILABLE_MEM MB available)"
            echo "ğŸ§¹ Running additional cleanup..."
            sudo sync
            echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
            echo "ğŸ“Š Memory after emergency cleanup:"
            free -h
          fi

          # CRITICAL: Validate main.py defines FastAPI app
          echo "ğŸ” Validating main.py..."
          MAIN_PY="/home/ubuntu/vernal-agents-post-v0/main.py"
          test -f "$MAIN_PY" || { echo "ERROR: main.py not found at $MAIN_PY!"; exit 1; }
          sleep 2  # Ensure file is fully written
          test -s "$MAIN_PY" || { echo "ERROR: main.py is empty!"; exit 1; }
          grep -q "app = FastAPI()" "$MAIN_PY" || { echo "ERROR: main.py must define app = FastAPI()! Showing contents:"; head -30 "$MAIN_PY"; exit 1; }
          grep -E "(from fastapi import FastAPI|import FastAPI)" "$MAIN_PY" || { echo "ERROR: main.py must import FastAPI! Showing contents:"; head -30 "$MAIN_PY"; exit 1; }
          echo "âœ… main.py validation passed"

          # 4. Restore and validate environment variables (EMERGENCY_NET.md v7)
          echo "ğŸ” Setting up environment..."
          
          # CRITICAL: Restore .env from backup if it exists, otherwise use /etc/environment
          if [ -f /home/ubuntu/.env.backup ]; then
            echo "âœ… Restoring .env from backup..."
            sudo cp /home/ubuntu/.env.backup .env
            sudo chown ubuntu:ubuntu .env
            chmod 600 .env
            echo "âœ… .env file restored from backup with preserved credentials"
          else
            echo "âš ï¸ No .env backup found, creating from /etc/environment..."
            sudo cp /etc/environment .env
            sudo chown ubuntu:ubuntu .env
            chmod 600 .env
            echo "âš ï¸ WARNING: .env created from /etc/environment - DB and JWT credentials may be missing!"
            echo "âš ï¸ Please verify .env contains DB_HOST, DB_USER, DB_PASSWORD, DB_NAME, and JWT_SECRET_KEY"
          fi

          # Validate critical environment variables (EMERGENCY_NET.md v7)
          echo "ğŸ” Validating environment variables..."
          REQUIRED_VARS=("DB_HOST" "DB_USER" "DB_PASSWORD" "DB_NAME" "OPENAI_API_KEY")
          MISSING_VARS=()

          # Check for presence of required variables
          for var in "${REQUIRED_VARS[@]}"; do
              if ! grep -q "^${var}=" .env; then
                  MISSING_VARS+=("$var")
              fi
          done

          if [ ${#MISSING_VARS[@]} -ne 0 ]; then
              echo "âŒ Missing required environment variables:"
              printf '%s\n' "${MISSING_VARS[@]}"
              echo "Please update /etc/environment or restore .env from backup"
              exit 1
          fi

          # CRITICAL: Validate no placeholder values (EMERGENCY_NET.md)
          echo "ğŸ” Validating no placeholder values..."
          if grep -E "myuser|localhost|dummy|mypassword" .env > /dev/null; then
              echo "âŒ CRITICAL: Placeholder values detected in .env file!"
              echo "âŒ Detected placeholders:"
              grep -E "myuser|localhost|dummy|mypassword" .env || true
              echo "âŒ This will cause database connection failures!"
              echo "âŒ Please restore .env from backup or manually configure with real credentials"
              exit 1
          fi

          echo "âœ… All required environment variables present with real values"

          # 5. Overwrite systemd unit (always)
          echo "âš™ï¸ Configuring systemd service..."
          sudo tee /etc/systemd/system/vernal-agents.service > /dev/null << 'SERVICE_EOF'
          [Unit]
          Description=Vernal Agents Backend
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/vernal-agents-post-v0
          ExecStart=/home/ubuntu/vernal-agents-post-v0/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=10
          Environment=PYTHONPATH=/home/ubuntu/vernal-agents-post-v0
          EnvironmentFile=/home/ubuntu/vernal-agents-post-v0/.env

          [Install]
          WantedBy=multi-user.target
          SERVICE_EOF

          # 6. Reload and start service
          echo "ğŸ”„ Starting service..."
          sudo systemctl daemon-reload
          sudo systemctl start vernal-agents

          # 7. Wait for startup
          echo "â³ Waiting for service startup..."
          sleep 10

          # Check service status and logs
          echo "ğŸ” Checking service status..."
          sudo systemctl status vernal-agents --no-pager
          echo "ğŸ” Checking service logs..."
          sudo journalctl -u vernal-agents -n 20 --no-pager

          # 8. Automated post-deploy validation (MANDATORY)
          echo "âœ… Running post-deploy validation..."

          # Health check with retry
          echo "ğŸ” Testing health endpoint..."
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f http://localhost:8000/health; then
              echo "âœ… Health check passed on attempt $i"
              break
            else
              echo "âŒ Health check failed on attempt $i, waiting 3 seconds..."
              sleep 3
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts!"
                exit 1
              fi
            fi
          done
          echo "âœ… Health check passed"

          # Version check
          echo "ğŸ” Testing version endpoint..."
          VERSION_RESPONSE=$(curl -s http://localhost:8000/version)
          echo "$VERSION_RESPONSE" | jq . || { echo "âŒ Version endpoint returned invalid JSON!"; exit 1; }
          echo "âœ… Version check passed"

          # Database test
          echo "ğŸ” Testing database connectivity..."
          curl -f http://localhost:8000/mcp/enhanced/health || { echo "âŒ Database test failed!"; exit 1; }
          echo "âœ… Database test passed"

          # Systemd status
          echo "ğŸ” Checking systemd status..."
          sudo systemctl status vernal-agents --no-pager || { echo "âŒ Service not running!"; exit 1; }
          echo "âœ… Service is running"

          # Port check
          echo "ğŸ” Checking port 8000..."
          if ! sudo lsof -i :8000 >/dev/null 2>&1; then
            echo "âŒ Port 8000 is not listening!"
            echo "ğŸ” Checking systemd logs for errors..."
            sudo journalctl -u vernal-agents -n 50 --no-pager
            echo "ğŸ” Verifying main.py defines app = FastAPI()..."
            grep -q "app = FastAPI" /home/ubuntu/vernal-agents-post-v0/main.py || echo "âŒ main.py does not define app = FastAPI()!"
            echo "ğŸ” Common causes: code bug, missing dependency, or main.py does not define app = FastAPI()"
            exit 1
          fi
          echo "âœ… Port 8000 is listening"

          # External access test
          echo "ğŸ” Testing external access..."
          curl -f https://themachine.vernalcontentum.com/health || { echo "âŒ External health check failed!"; exit 1; }
          curl -f https://themachine.vernalcontentum.com/version || { echo "âŒ External version check failed!"; exit 1; }
          curl -f https://themachine.vernalcontentum.com/mcp/enhanced/health || { echo "âŒ External database test failed!"; exit 1; }
          echo "âœ… External access working"

          # 9. Verify deployment completion with commit hash
          echo "ğŸ” Verifying deployment completion..."
          COMMIT_HASH=$(git rev-parse HEAD)
          PYTHON_VERSION=$(python --version)
          
          # Final memory check
          echo "ğŸ“Š Final memory status:"
          free -h
          
          # Write completion marker file
          echo "DEPLOY_COMPLETE_$(date +%s)_$COMMIT_HASH" > /home/ubuntu/vernal_agents_deploy_complete.txt
          
          # Copy verification script for manual use
          cp verify_deployment.sh /home/ubuntu/verify_deployment.sh
          chmod +x /home/ubuntu/verify_deployment.sh
          
          # Copy lightweight deployment script
          cp deploy_lightweight.sh /home/ubuntu/deploy_lightweight.sh
          chmod +x /home/ubuntu/deploy_lightweight.sh
          
          # Log successful deployment
          echo "$(date) - BULLETPROOF Backend deployed successfully via GitHub Actions, commit: $COMMIT_HASH, Python: $PYTHON_VERSION" >> ~/vernal_agents_deploy.log
          
          # Final verification - test commit hash endpoint
          echo "ğŸ” Testing commit hash endpoint..."
          curl -sf http://localhost:8000/deploy/commit || echo "âš ï¸ Commit endpoint skipped (non-fatal)"
          
          echo "ğŸ‰ BULLETPROOF BACKEND DEPLOYMENT SUCCESSFUL!"
          echo "ğŸ“ Deployment logged to ~/vernal_agents_deploy.log"
          echo "ğŸ“ Completion marker: /home/ubuntu/vernal_agents_deploy_complete.txt"
          echo "ğŸ”— Commit hash: $COMMIT_HASH"
          echo "ğŸ”§ Manual verification: /home/ubuntu/verify_deployment.sh"
          echo "ğŸš€ Lightweight deploy: /home/ubuntu/deploy_lightweight.sh"
