# Copy Refactor Prompt Button - Implementation Specification

**Purpose:** Defines the exact implementation for the "Copy Refactor Prompt" button in the Guard Rails UI.

**Location:** Admin page → System → Guard Rails → Violations table → "Copy Refactor Prompt" button

---

## Current Implementation (What It Should Do)

### Backend Endpoint
**POST `/admin/code-health/refactor-prompt`**

**Request:**
```json
{
  "file_path": "/home/ubuntu/vernal-agents-post-v0/app/routes/content.py",
  "lines": 3030,
  "threshold": 3000
}
```

**Response:**
```json
{
  "status": "success",
  "prompt": "# Refactor Task: content.py\n\n## File Information\n...",
  "file_path": "/home/ubuntu/vernal-agents-post-v0/app/routes/content.py",
  "lines": 3030,
  "threshold": 3000
}
```

### Frontend Implementation (Required)

The button should:

1. **Call the backend endpoint:**
   ```typescript
   const handleCopyRefactorPrompt = async (violation: {
     file: string;
     lines: number;
     threshold: number;
   }) => {
     try {
       const response = await fetch('/admin/code-health/refactor-prompt', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
           'Authorization': `Bearer ${token}`, // JWT token
         },
         body: JSON.stringify({
           file_path: violation.file,
           lines: violation.lines,
           threshold: violation.threshold,
         }),
       });

       if (!response.ok) {
         throw new Error(`HTTP error! status: ${response.status}`);
       }

       const data = await response.json();
       
       if (data.status === 'success' && data.prompt) {
         // Copy prompt to clipboard
         await navigator.clipboard.writeText(data.prompt);
         toast.success('Refactor prompt copied to clipboard!');
       } else {
         throw new Error(data.message || 'Failed to generate prompt');
       }
     } catch (error) {
       console.error('Error copying refactor prompt:', error);
       toast.error(`Failed to copy prompt: ${error.message}`);
     }
   };
   ```

2. **Button click handler:**
   ```typescript
   <Button
     onClick={() => handleCopyRefactorPrompt({
       file: violation.file,
       lines: violation.lines,
       threshold: violation.threshold,
     })}
     variant="outline"
     size="sm"
   >
     Copy Refactor Prompt
   </Button>
   ```

---

## What the Prompt Includes (From Backend)

The prompt generated by `generate_refactor_prompt()` includes:

1. **CRITICAL: Backup Before Refactoring** (REQUIRED FIRST STEP)
   ```bash
   bash guardrails/backup_before_refactor.sh [file_path]
   ```

2. **Refactoring Constraints:**
   - Non-negotiable constraints (API contracts, runtime config, etc.)
   - Do NOT modify list (auth, scheduler, database, etc.)
   - STOP conditions

3. **Refactoring Strategy:**
   - Create `app/` package structure
   - One module at a time
   - Package boundary pinning
   - Router parity checks

4. **Step-by-Step Process:**
   - Before: Backup, syntax check, verify service
   - During: Extract, create routers, include in main.py
   - After: Compare with backup, syntax check, verify structure, test

5. **Comparison & Restore Tools:**
   - `bash guardrails/compare_refactor.sh` - Compare old vs new
   - `bash guardrails/restore_from_backup.sh` - Restore if needed

6. **Documentation References:**
   - Links to `guardrails/REFACTORING.md`
   - Links to `guardrails/SYNTAX_CHECKING.md`
   - Links to `docs/MASTER_DIAGNOSTIC_ROUTER.md`

---

## Verification

To verify the button works correctly:

1. **Test the endpoint:**
   ```bash
   curl -X POST http://127.0.0.1:8000/admin/code-health/refactor-prompt \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer [token]" \
     -d '{
       "file_path": "/home/ubuntu/vernal-agents-post-v0/app/routes/content.py",
       "lines": 3030,
       "threshold": 3000
     }'
   ```

2. **Check the prompt includes:**
   - ✅ Backup command as first step
   - ✅ All constraints
   - ✅ Step-by-step process
   - ✅ Comparison/restore tools
   - ✅ Documentation references

---

## Backend Function

**Location:** `code_health/scanner.py`

**Function:** `generate_refactor_prompt(file_path, lines, threshold, constraints=None)`

**What it does:**
- Generates comprehensive refactor prompt
- Includes backup procedures (REQUIRED FIRST STEP)
- Includes all constraints from existing docs
- Includes step-by-step process
- Includes comparison/restore tools
- References existing documentation (doesn't duplicate)

---

## Key Points

1. **Backend is ready** - `POST /admin/code-health/refactor-prompt` endpoint exists
2. **Prompt includes backup** - Backup is the REQUIRED FIRST STEP
3. **References existing docs** - Doesn't duplicate `REFACTORING.md`, references it
4. **Includes new tools** - References backup/compare/restore scripts we just created

---

## Frontend Implementation Checklist

- [ ] Button calls `POST /admin/code-health/refactor-prompt`
- [ ] Sends `file_path`, `lines`, `threshold` in request body
- [ ] Includes JWT token in Authorization header
- [ ] Copies `response.prompt` to clipboard
- [ ] Shows success toast when copied
- [ ] Shows error toast if request fails
- [ ] Handles loading state (optional but recommended)

---

**Last Updated:** 2025-01-XX  
**Status:** Backend ready, frontend needs to call new endpoint

